{
  "hash": "1246135d2625f56062c00be71ce28d66",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"diffusionMaps\"\nformat:\n  html:\n    toc: true\n    toc-location: right\n    number-sections: true\n    code-fold: false\n    sidebar: true\neditor: visual\neditor_options: \n  chunk_output_type: console\nknitr:\n  opts_chunk: \n    message: false\n    warning: false\n    code-fold: false\n    include: true\n    collapse: true\n    eval: true\n    fig.show: hold\n---\n\n\n\n\n## Introduction\n\nIn this tutorial, we explore **Diffusion Maps** and **PHATE**, two powerful nonlinear dimensionality reduction techniques that excel in capturing the geometric structure of complex datasets, particularly in life sciences. They are especially useful for continuous processes, such as cell development or biological trajectories.\n\n## Diffusion Maps\n\n-   **Diffusion maps** leverage the relationship between heat diffusion and a random walk Markov chain on the dataset. The basic idea is that in a random walk, you're more likely to step to a nearby point than one farther away.\n-   The connectivity between two points is defined as the probability of transitioning from one to the other in one step, typically via a **kernel function**. This defines the local geometry and leads to construction of a **transition matrix (M)** for the Markov chain.\n-   Raising **M** to higher powers simulates a diffusion process over time, revealing the geometric structure at increasing scales. The parameter *t* acts as both a time and scale parameter.\n-   The **diffusion distance** between two points at time *t* reflects their similarity based on how many short paths connect them. It is robust to noise and integrates all indirect connections—making it suitable for inference tasks.\n-   This distance can be computed from the **eigenvectors and eigenvalues** of the diffusion matrix.\n-   By keeping only the first *k* eigenvectors and their eigenvalues (due to spectral decay), the data is embedded in a *k*-dimensional space. The resulting **diffusion map** is a nonlinear embedding where Euclidean distances approximate diffusion distances, capturing the intrinsic geometry of the original data.\n\n## Data\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\nlibrary(tidyverse)\nlibrary(mixOmics)\n\n# load data\ndata(breast.TCGA)\nx <- rbind(breast.TCGA$data.train$mirna,breast.TCGA$data.test$mirna)\nlabels <-c(breast.TCGA$data.train$subtype,breast.TCGA$data.test$subtype)\n\n# scale data\nx_scaled <- scale(x)\n\n# preview data\n# data dimensions\nx |> dim() |> print () # dimensions of the data matrix (samples x features)\n## [1] 220 184\nlabels |> as.factor() |> summary() # samples per group\n## Basal  Her2  LumA \n##    66    44   110\n\n# box plots \npar(mfrow=c(2,1))\nboxplot(t(x), main=\"distribution per sample\", las=2, cex.axis=0.7, col=rainbow(10), outline=FALSE, cex.main=0.8)\nboxplot(x, main=\"distribution per miRNA\", las=2, cex.axis=0.7, col=rainbow(10), outline=FALSE, cex.main=0.8)\n\n```\n\n::: {.cell-output-display}\n![](diffusionMaps_files/figure-html/unnamed-chunk-1-1.png){width=1152}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\n# perform PCA\n# perform PCA\npca <- prcomp(x, center=TRUE, scale.=FALSE)\neigs <- pca$sdev^2\nvar_exp <- eigs / sum(eigs)\n\nres_pca <- data.frame(PC1=pca$x[,1], PC2=pca$x[,2], PC3=pca$x[,3], PC4=pca$x[,4], PC5=pca$x[,5]) |>\n    rownames_to_column(\"sample\") |> \n    as_tibble() \n\nres_pca_loadings <- pca$rotation\n\n# show PCA scores plots\nres_pca |>\n    ggplot(aes(x=PC1, y=PC2, color=labels)) +\n    geom_point() +\n    labs(title=\"PCA of miRNA data\", x=\"PC1\", y=\"PC2\") +\n    xlab(paste(\"PC1 (Var: \", round(var_exp[1] * 100, 2), \"%)\")) +\n    ylab(paste(\"PC2 (Var: \", round(var_exp[2] * 100, 2), \"%)\")) +\n    theme_minimal() +\n    scale_color_manual(values=c(\"Basal\"=\"#FF0000\", \"Her2\"=\"#00FF00\", \"LumA\"=\"#0000FF\")) +\n    theme(legend.title=element_blank())\n\n# show top 10 loadings along PC1\nres_pca_loadings |> \n    as.data.frame() |> \n    rownames_to_column(\"miRNA\") |> \n    arrange(desc(abs(PC1))) |> \n    head(10) |> \n    ggplot(aes(x=reorder(miRNA, PC1), y=PC1)) +\n    geom_bar(stat=\"identity\", fill=\"steelblue\") +\n    coord_flip() +\n    labs(title=\"Top 10 miRNAs contributing to PC1\", x=\"miRNA\", y=\"Loading\") +\n    theme_minimal()\n\n```\n\n::: {.cell-output-display}\n![](diffusionMaps_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](diffusionMaps_files/figure-html/unnamed-chunk-2-2.png){width=672}\n:::\n:::\n\n\n\n\n\n## Run diffusionMap\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\nlibrary(destiny) # main package for diffusion maps\n\ndm <- DiffusionMap(data = x_scaled, sigma = \"local\")  # adaptive kernel width\n\n# Key parameters\n# - sigma: \tDiffusion scale parameter of the Gaussian kernel\n# - k: \tNumber of neighbors\n# - n_eigs: Number of diffusion components to calculate\n# - density.norm: Density normalization (helps manifold discovery)\n\ndf_dm <- data.frame(\n  DC1 = eigenvectors(dm)[, 1],\n  DC2 = eigenvectors(dm)[, 2],\n  Subtype = labels\n)\n\n# Visualize First Two Diffusion Components\nggplot(df_dm, aes(x = DC1, y = DC2, color = Subtype)) +\n  geom_point(size = 2) +\n  theme_minimal() +\n  labs(title = \"Diffusion Map of miRNA Data\")\n\n#  Explore Diffusion Pseudotime (Optional)\ndf_dm$Pseudotime <- eigenvectors(dm)[, 1]\n\nggplot(df_dm, aes(x = DC1, y = DC2, color = Pseudotime)) +\n  geom_point(size = 2) +\n  scale_color_viridis_c() +\n  theme_minimal() +\n  labs(title = \"Diffusion Pseudotime\", color = \"Pseudotime\")\n\n```\n\n::: {.cell-output-display}\n![](diffusionMaps_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](diffusionMaps_files/figure-html/unnamed-chunk-3-2.png){width=672}\n:::\n:::\n\n\n\n\n## Exercise\n\n\n\n\n\n\n\n\n\nWe have simulated a dataset with 100 cells and 20 genes, where 3 genes have a signal related to pseudotime. Load the data `diffmap-sim-gene-expr.csv` and run a diffusion map analysis. Could you identify the genes that correlate with the first diffusion component?\n\nHint: \n\n- there should be one gene highly positively correlated with the first diffusion component and one negatively correlated.\n\n**Example code**\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\nlibrary(tidyverse)\nlibrary(destiny)\nlibrary(viridis)\n\n# Load the simulated data\nexpr_data <- read_csv(\"data/diffmap-sim-gene-expr.csv\")\n\n# scale data\nx <- scale(expr_data)\n\n# Run Diffusion Map\ndm <- DiffusionMap(data = x, sigma = \"local\")  # adaptive kernel width\n\ndf_dm <- data.frame(\n  DC1 = eigenvectors(dm)[, 1],\n  DC2 = eigenvectors(dm)[, 2]\n)\n\n# Visualize First Two Diffusion Components\nggplot(df_dm, aes(x = DC1, y = DC2)) +\n  geom_point(size = 2) +\n  theme_minimal() +\n  labs(title = \"Diffusion Map of miRNA Data\")\n\n#  Explore Diffusion Pseudotime (Optional)\ndf_dm$Pseudotime <- eigenvectors(dm)[, 1]\n\nggplot(df_dm, aes(x = DC1, y = DC2, color = Pseudotime)) +\n  geom_point(size = 2) +\n  scale_color_viridis_c() +\n  theme_minimal() +\n  labs(title = \"Diffusion Pseudotime\", color = \"Pseudotime\")\n```\n\n::: {.cell-output-display}\n![](diffusionMaps_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](diffusionMaps_files/figure-html/unnamed-chunk-5-2.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\n# find genes positively and negatively correlated with DC1\ndc1 <- eigenvectors(dm)[, 1]\n\n# Correlate each gene with DC1\ncor_with_dc1 <- apply(x, 2, function(g) cor(g, dc1))\n\n# top genes positively correlated with DC1\ncor_with_dc1_sorted <- sort(cor_with_dc1, decreasing = TRUE)\nhead(cor_with_dc1_sorted, 5)\n##     Gene18     Gene15      Gene9      Gene1     Gene20 \n## 0.91409842 0.31069956 0.18258365 0.09695313 0.08421495\n\n# color code UMAP by the expression of the correlated genes\nlibrary(viridis)\n\nggplot(df_dm, aes(x = DC1, y = DC2, color = expr_data$Gene5, size = expr_data$Gene5)) +\n  geom_point(alpha = 0.9) +\n  scale_color_viridis_c(option = \"plasma\", name = \"Expression\") +\n  scale_size(range = c(1, 4), guide = \"none\") +\n  theme_minimal() +\n  labs(\n    title = \"Diffusion Map Colored by Gene Expression\",\n    x = \"DC1\", y = \"DC2\"\n  )\n\n# top genes negatively correlated with DC1\ncor_with_dc1_sorted <- sort(cor_with_dc1, decreasing = FALSE)\nhead(cor_with_dc1_sorted, 5)\n##      Gene7     Gene12     Gene19      Gene2      Gene8 \n## -0.9155005 -0.2076297 -0.1958369 -0.1670577 -0.1650107\n\n# color code UMAP by the expression of the correlated genes\nggplot(df_dm, aes(x = DC1, y = DC2, color = expr_data$Gene18, size = expr_data$Gene18)) +\n  geom_point(alpha = 0.9) +\n  scale_color_viridis_c(option = \"plasma\", name = \"Expression\") +\n  scale_size(range = c(1, 4), guide = \"none\") +\n  theme_minimal() +\n  labs(\n    title = \"Diffusion Map Colored by Gene Expression\",\n    x = \"DC1\", y = \"DC2\"\n  )\n\n```\n\n::: {.cell-output-display}\n![](diffusionMaps_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](diffusionMaps_files/figure-html/unnamed-chunk-6-2.png){width=672}\n:::\n:::\n\n\n\n\n## Additional resources\n\nPHATE (Potential of Heat-diffusion for Affinity-based Transition Embedding) aims to capture both local and global nonlinear structure by using an information-geometric distance derived from a heat-diffusion process. PHATE builds on diffusion maps by modeling data as a diffusion process but introduces key innovations like automatic selection of diffusion time and a log-transformed “potential distance” to better preserve both local and global structure. Unlike diffusion maps, which use eigenvectors for embedding, PHATE applies non-metric multidimensional scaling for improved visualization of trajectories and branching structures\n\n-   [PHATE R Bone Marrow Tutorial R](http://htmlpreview.github.io/?https://github.com/KrishnaswamyLab/phateR/blob/master/inst/examples/bonemarrow_tutorial.html)\n\n-   [PHATE Python Tutorial](https://nbviewer.org/github/KrishnaswamyLab/PHATE/blob/main/Python/tutorial/EmbryoidBody.ipynb)\n",
    "supporting": [
      "diffusionMaps_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}